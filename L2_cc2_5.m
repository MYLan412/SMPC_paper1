clear all;
close all;
%% [e(k) Δx(k) X_R(k)]  30*30  这是例1中预见长度为 1 的程序
I_N = eye(5);
I_m = eye(1);
I_mN = eye(5);
I_s = eye(30);
A_R = [ zeros(5,5)  eye(5);
        zeros(5,10)];
A_R_3 = [ zeros(5,5)  eye(5);
        zeros(5,10)];

A1 =  [  0.0571    0.0200    0.7000
        -0.0571    0.0400    0.0100
        0.0013    -0.0083    0.1000 ] ;
A2 = [ 0.0571     0.0200    0.7000
       -0.0571    0.0400    0.0100
       0.0026    -0.0165    0.1000] ;
B = [  2;
       0;
       0 ];
  
A1_d = [    0.0063    0.0040    0.0040
           -0.0063    0.0500    0.0800
            0.0023    0.0075   -0.2000 ];
     
A2_d = [    0.0063    0.0020    0.0060
           -0.0063    0.0200    0.0700
            0.0047    0.0052   -0.2000 ];
     
C = [-0.02  -0.01   -0.01 ];

L = [ 4  -1  -1  -1  -1 ;
      0  3  -1  -1  -1;
     -1  0  3   -1   -1;
      -1  -1  -1   4  -1;
     -1  -1  -1  -1   4];
M = [ 1 0 0 0 0;
      0 1 0 0 0;
      0 0 1 0 0;
      0 0 0 1 0;
      0 0 0 0 1 ];
H = L + M;

A_R0_1 = [    I_N  kron(-H,C*A1)  zeros(5)  kron(M,I_m);
            zeros(15,5)  kron(I_N,A1)  zeros(15,10);
            zeros(10,20)  A_R    ];
A_R0_1_d = [ zeros(5)  kron(-H,C*A1_d)  zeros(5,10);
             zeros(15,5)  kron(I_N,A1_d)  zeros(15,10);
             zeros(10,30)];

A_R0_2 = [    I_N  kron(-H,C*A2)  zeros(5)  kron(M,I_m);
            zeros(15,5)  kron(I_N,A2)  zeros(15,10);
            zeros(10,20)  A_R    ];
A_R0_2_d = [ zeros(5)  kron(-H,C*A2_d)  zeros(5,10);
             zeros(15,5)  kron(I_N,A2_d)  zeros(15,10);
             zeros(10,30)];

B_R0 = [    kron(-H,C*B);
            kron(I_N,B);
            zeros(10,5) ];
G_hat = eye(30) - B_R0*inv(B_R0'*B_R0)*B_R0';

F = [ kron(-H,C);
      eye(15);
      zeros(10,15)];
D = [ eye(5)  zeros(5,25) ];

% %%
% setlmis([]);
% 
% %%
% % 
% gama = lmivar(2,[1,1]);
% % 表示矩阵
% P0 = lmivar(1,[30,1]); % P
% Q0 = lmivar(1,[30,1]); % Q
% R0 = lmivar(1,[30,1]);  % R
% Y01 = lmivar(2,[5,30]); % Y1
% Y02 = lmivar(2,[5,30]); % Y2
% 
% 
% %% 第一个大矩阵 < 0
% % (1,1)
% lmiterm([1 1 1 Q0],1,1);
% % lmiterm([1 1 1 R0'],-(A_R0_1-eye(35)),1);
% lmiterm([1 1 1 Y01],-B_R0,1,'s');
% lmiterm([1 1 1 R0],-1,(A_R0_1-I_s)','s');
% % lmiterm([1 1 1 Y01'],-1,B_R0');
% 
% % (1,2)
% lmiterm([1 1 2 P0],1,1);
% lmiterm([1 1 2 R0'],1,1);
% lmiterm([1 1 2 -R0],1,(A_R0_1-I_s)');
% lmiterm([1 1 2 -Y01'],1,B_R0');
% 
% % (1,3)
% lmiterm([1 1 3 R0'],-G_hat*A_R0_1_d,1);
% 
% % (1,4)
% lmiterm([1 1 4 0],-G_hat*F);
% 
% % (1,5)
% lmiterm([1 1 5 R0],1,D');
% 
% % (2,2)
% lmiterm([1 2 2 P0],1,1);
% lmiterm([1 2 2 R0],1,1,'s');
% % lmiterm([1 2 2 R0'],1,1);
% 
% % (2,3)
% lmiterm([1 2 3 R0'],-G_hat*A_R0_1_d,1);
% 
% % (2,4)
% lmiterm([1 2 4 0],-G_hat*F);
% 
% % (2,5)
% lmiterm([1 2 5 0],0);
% 
% % (3,3)
% lmiterm([1 3 3 Q0],-1,1);
% 
% % (3,4)
% lmiterm([1 3 4 0],0);
% 
% % (3,5)
% lmiterm([1 3 5 0],0);
% 
% % (4,4)
% lmiterm([1 4 4 gama^2],-1,eye(15));
% 
% % (4,5)
% lmiterm([1 4 5 0],0);
% 
% % (5,5)
% lmiterm([1 5 5 0],-eye(5));
% 
% %% 第二个大矩阵 < 0
% % (1,1)
% lmiterm([2 1 1 Q0],1,1);
% % lmiterm([1 1 1 R0'],-(A_R0_1-eye(35)),1);
% lmiterm([2 1 1 Y02],-B_R0,1,'s');
% lmiterm([2 1 1 R0],-1,(A_R0_2-I_s)','s');
% % lmiterm([1 1 1 Y01'],-1,B_R0');
% 
% % (1,2)
% lmiterm([2 1 2 P0],1,1);
% lmiterm([2 1 2 R0'],1,1);
% lmiterm([2 1 2 -R0],1,(A_R0_2-I_s)');
% lmiterm([2 1 2 -Y02'],1,B_R0');
% 
% % (1,3)
% lmiterm([2 1 3 R0'],-G_hat*A_R0_2_d,1);
% 
% % (1,4)
% lmiterm([2 1 4 0],-G_hat*F);
% 
% % (1,5)
% lmiterm([2 1 5 R0],1,D');
% 
% % (2,2)
% lmiterm([2 2 2 P0],1,1);
% lmiterm([2 2 2 R0],1,1,'s');
% % lmiterm([1 2 2 R0'],1,1);
% 
% % (2,3)
% lmiterm([2 2 3 R0'],-G_hat*A_R0_2_d,1);
% 
% % (2,4)
% lmiterm([2 2 4 0],-G_hat*F);
% 
% % (2,5)
% lmiterm([2 2 5 0],0);
% 
% % (3,3)
% lmiterm([2 3 3 Q0],-1,1);
% 
% % (3,4)
% lmiterm([2 3 4 0],0);
% 
% % (3,5)
% lmiterm([2 3 5 0],0);
% 
% % (4,4)
% lmiterm([2 4 4 gama^2],-1,eye(15));
% 
% % (4,5)
% lmiterm([2 4 5 0],0);
% 
% % (5,5)
% lmiterm([2 5 5 0],-eye(5));
% 
% %% 第三个大矩阵 < 0
% % (1,1)
% lmiterm([3 1 1 Q0],2,1);
% lmiterm([3 1 1 R0'],-(3/2)*(A_R0_1-I_s),1,'s');
% lmiterm([3 1 1 Y02],-(1/2)*B_R0,1,'s');
% lmiterm([3 1 1 R0'],-(1/2)*(A_R0_2-I_s),1,'s');
% lmiterm([3 1 1 Y01],-(3/2)*B_R0,1,'s');
% 
% % (1,2)
% lmiterm([3 1 2 P0],2,1);
% lmiterm([3 1 2 R0'],2,1);
% lmiterm([3 1 2 -R0],3/2,(A_R0_1-I_s)');
% lmiterm([3 1 2 -Y02'],1/2,B_R0');
% lmiterm([3 1 2 -R0],1/2,(A_R0_2-I_s)');
% lmiterm([3 1 2 -Y01'],3/2,B_R0');
% 
% % (1,3)
% lmiterm([3 1 3 R0'],-(3/2)*G_hat*A_R0_1_d,1);
% lmiterm([3 1 3 R0'],-(1/2)*G_hat*A_R0_2_d,1);
% 
% % (1,4)
% lmiterm([3 1 4 0],-2*G_hat*F);
% 
% % (1,5)
% lmiterm([3 1 5 R0],2,D');
% 
% % (2,2)
% lmiterm([3 2 2 P0],2,1);
% lmiterm([3 2 2 R0],2,1,'s');
% 
% % (2,3)
% lmiterm([3 2 3 R0'],-(3/2)*G_hat*A_R0_1_d,1);
% lmiterm([3 2 3 R0'],-(1/2)*G_hat*A_R0_2_d,1);
% 
% % (2,4)
% lmiterm([3 2 4 0],-2*G_hat*F);
% 
% % (2,5)
% lmiterm([3 2 5 0],0);
% 
% % (3,3)
% lmiterm([3 3 3 Q0],-2,1);
% 
% % (3,4)
% lmiterm([3 3 4 0],0);
% 
% % (3,5)
% lmiterm([3 3 5 0],0);
% 
% % (4,4)
% lmiterm([3 4 4 gama^2],-2,eye(15));
% 
% % (4,5)
% lmiterm([3 4 5 0],0);
% 
% % (5,5)
% lmiterm([3 5 5 0],-2*eye(5));
% 
% %% 第四个大矩阵 < 0
% % (1,1)
% lmiterm([4 1 1 Q0],2,1);
% lmiterm([4 1 1 R0'],-(1/2)*(A_R0_1-I_s),1,'s');
% lmiterm([4 1 1 Y02],-(3/2)*B_R0,1,'s');
% lmiterm([4 1 1 R0'],-(3/2)*(A_R0_2-I_s),1,'s');
% lmiterm([4 1 1 Y01],-(1/2)*B_R0,1,'s');
% 
% % (1,2)
% lmiterm([4 1 2 P0],2,1);
% lmiterm([4 1 2 R0'],2,1);
% lmiterm([4 1 2 -R0],1/2,(A_R0_1-I_s)');
% lmiterm([4 1 2 -Y02'],3/2,B_R0');
% lmiterm([4 1 2 -R0],3/2,(A_R0_2-I_s)');
% lmiterm([4 1 2 -Y01'],1/2,B_R0');
% 
% % (1,3)
% lmiterm([4 1 3 R0'],-(1/2)*G_hat*A_R0_1_d,1);
% lmiterm([4 1 3 R0'],-(3/2)*G_hat*A_R0_2_d,1);
% 
% % (1,4)
% lmiterm([4 1 4 0],-2*G_hat*F);
% 
% % (1,5)
% lmiterm([4 1 5 R0],2,D');
% 
% % (2,2)
% lmiterm([4 2 2 P0],2,1);
% lmiterm([4 2 2 R0],2,1,'s');
% 
% % (2,3)
% lmiterm([4 2 3 R0'],-(1/2)*G_hat*A_R0_1_d,1);
% lmiterm([4 2 3 R0'],-(3/2)*G_hat*A_R0_2_d,1);
% 
% % (2,4)
% lmiterm([4 2 4 0],-2*G_hat*F);
% 
% % (2,5)
% lmiterm([4 2 5 0],0);
% 
% % (3,3)
% lmiterm([4 3 3 Q0],-2,1);
% 
% % (3,4)
% lmiterm([4 3 4 0],0);
% 
% % (3,5)
% lmiterm([4 3 5 0],0);
% 
% % (4,4)
% lmiterm([4 4 4 gama^2],-2,eye(15));
% 
% % (4,5)
% lmiterm([4 4 5 0],0);
% 
% % (5,5)
% lmiterm([4 5 5 0],-2*eye(5));
% 
% 
% %% 约束条件
% lmiterm([-5 1 1 P0],1,1);
% lmiterm([5 1 1 0],0);
% 
% lmiterm([-6 1 1 gama],1,1);
% lmiterm([6 1 1 0],0);
% 
% lmiterm([-7 1 1 Q0],1,1);
% lmiterm([7 1 1 0],0);
% 
% %%
% lmisys=getlmis;
% options=[0,0,0,0,0];
% [tmin,xfeas]=feasp(lmisys,options); 
% 
% %%
% gama = dec2mat(lmisys,xfeas,gama);
% P0 = dec2mat(lmisys,xfeas,P0);
% Q0 = dec2mat(lmisys,xfeas,Q0);
% R0 = dec2mat(lmisys,xfeas,R0);
% Y01 = dec2mat(lmisys,xfeas,Y01);
% Y02 = dec2mat(lmisys,xfeas,Y02);
% 
% K1_30 = Y01 * inv(R0')
% K2_30 = Y02 * inv(R0')

K1_30 = [-5.86874263111341,-1.26202309044063,-1.22432128129075,-1.00509296391336,-1.00509296391291,0.0594845629309557,-0.0115884806076846,-0.363081785303796,0.0102404959591927,0.00117004414537193,0.00185265210520910,0.0116718150773510,0.00130110369647702,0.00231220160865915,0.0113446272526504,0.00126579503944939,0.00226994073025579,0.0113446272526350,0.00126579503944670,0.00226994073025925,0.0136004018985317,-0.000509298822842241,-0.00265125335436078,-0.00238675178321148,-0.00238675178318227,-4.24493561298215,-1.31033776487612,-1.51842241950813,-1.26932513586200,-1.26932513586208;-0.117894763098940,-6.26875322797005,-1.53048574506881,-0.944912133801433,-0.944912133801379,0.0102404959592162,0.00117004414537454,0.00185265210521782,0.0621660660040904,-0.0113535712983315,-0.362147701401301,0.0102536188568121,0.00119996582355361,0.00170484365626798,0.0114275761893869,0.00127800892901258,0.00225181771738507,0.0114275761893598,0.00127800892901314,0.00225181771739123,-0.00334612398037871,0.0123096521835405,-0.000723537639666838,-0.00257149431932856,-0.00257149431929469,-0.504513673359741,-4.78598594272307,-1.60095341788955,-1.23192488705558,-1.23192488705558;-0.789318148735610,-0.0880953387481526,-6.47266478324848,-0.858796242325639,-0.858796242325365,0.0116718150773332,0.00130110369647283,0.00231220160866285,0.0102536188567883,0.00119996582355382,0.00170484365626096,0.0627312265774245,-0.0112734750334864,-0.362129076590155,0.0116414400946358,0.00131021735628711,0.00223787886083735,0.0116414400946336,0.00131021735628277,0.00223787886084323,-0.00252547339818578,-0.00371402790304525,0.0119111940264717,-0.00280797404539283,-0.00280797404540544,-1.07273834340462,-0.517879409809469,-5.03461067410878,-1.17465750723245,-1.17465750723294;-0.759744974542848,-0.895247965456148,-1.17470793169540,-6.01668282227148,-0.942049265942397,0.0113446272526780,0.00126579503944735,0.00226994073026084,0.0114275761894026,0.00127800892901031,0.00225181771737241,0.0116414400946080,0.00131021735628208,0.00223787886083374,0.0597894467755309,-0.0115458927288289,-0.363079476576211,0.0114462807133609,0.00128068126515906,0.00225279297141412,-0.00239789458988443,-0.00253944252562527,-0.00276870842349030,0.0133423993537846,-0.00257630702553107,-1.02763759791290,-1.17889115881988,-1.48290272036447,-4.42210010065379,-1.22958042246391;-0.759744974543453,-0.895247965456253,-1.17470793169523,-0.942049265942211,-6.01668282227149,0.0113446272526555,0.00126579503944917,0.00226994073026149,0.0114275761893771,0.00127800892901202,0.00225181771738441,0.0116414400946325,0.00131021735628224,0.00223787886083468,0.0114462807133811,0.00128068126516140,0.00225279297142864,0.0597894467755535,-0.0115458927288292,-0.363079476576211,-0.00239789458989077,-0.00253944252558717,-0.00276870842352367,-0.00257630702553584,0.0133423993537749,-1.02763759791277,-1.17889115882019,-1.48290272036477,-1.22958042246359,-4.42210010065367];


K2_30 = [-5.87244383974563,-1.26294534779192,-1.22532394030261,-1.00593381085381,-1.00593381085365,0.0592646734153564,-0.0110815765226006,-0.364300848916281,0.0102457899262041,0.00110912269016896,0.00160613168063033,0.0116783358752426,0.00121298706798796,0.00200577046796309,0.0113509353974120,0.00117617893683767,0.00196593463642443,0.0113509353974098,0.00117617893683694,0.00196593463642710,0.0136274201977918,-0.000510180460873240,-0.00265720743628238,-0.00239229060889359,-0.00239229060888640,-4.24704676932989,-1.31117079723216,-1.51946248133086,-1.27020108927303,-1.27020108927288;-0.118099389534420,-6.27284523735705,-1.53160518086440,-0.945710918546665,-0.945710918547003,0.0102457899262398,0.00110912269017284,0.00160613168063753,0.0619486310254306,-0.0109048995127286,-0.363489120646096,0.0102584829383327,0.00115135706992739,0.00147424697675161,0.0114338929610206,0.00119200411725787,0.00195182042851121,0.0114338929609907,0.00119200411725924,0.00195182042851787,-0.00335254665331398,0.0123324149039339,-0.000724655164893904,-0.00257725863902169,-0.00257725863900731,-0.504956174423501,-4.78847356261868,-1.60197699208273,-1.23278481949156,-1.23278481949145;-0.790003373821506,-0.0882817046873620,-6.47690873169572,-0.859534592726453,-0.859534592726034,0.0116783358752625,0.00121298706798791,0.00200577046796610,0.0102584829383179,0.00115135706992797,0.00147424697674351,0.0625138459441516,-0.0108211489355299,-0.363474851439433,0.0116477528237797,0.00122813138480655,0.00193992423708616,0.0116477528237890,0.00122813138480289,0.00193992423709437,-0.00253118728981982,-0.00372078126921609,0.0119335179699138,-0.00281398307739791,-0.00281398307741632,-1.07349691325716,-0.518347374760004,-5.03727039259906,-1.17549199673704,-1.17549199673741;-0.760407541046671,-0.896010347346639,-1.17567560775102,-6.02049388816887,-0.942846093740816,0.0113509353974426,0.00117617893683643,0.00196593463642836,0.0114338929610453,0.00119200411725896,0.00195182042849603,0.0116477528237567,0.00122813138480145,0.00193992423708265,0.0595696040454308,-0.0110355165497086,-0.364298506965304,0.0114525954286266,0.00119468037894966,0.00195243572974280,-0.00240338564053599,-0.00254515394841248,-0.00277475095516190,0.0133690890185906,-0.00258207152980056,-1.02836435818521,-1.17971699035789,-1.48392642732025,-4.42433180426844,-1.23043925013835;-0.760407541047139,-0.896010347346938,-1.17567560775068,-0.942846093740728,-6.02049388816930,0.0113509353974198,0.00117617893683765,0.00196593463642837,0.0114338929610346,0.00119200411726242,0.00195182042850749,0.0116477528237731,0.00122813138480033,0.00193992423708649,0.0114525954286247,0.00119468037894941,0.00195243572975736,0.0595696040454524,-0.0110355165497080,-0.364298506965311,-0.00240338564053500,-0.00254515394839615,-0.00277475095517721,-0.00258207152979118,0.0133690890185599,-1.02836435818519,-1.17971699035790,-1.48392642732079,-1.23043925013829,-4.42433180426815];

%% [e(k) Δx(k) X_R(k) ] 30*30
A_R0_1_3 = [    I_N  kron(-H,C*A1)  zeros(5)  kron(M,I_m);
            zeros(15,5)  kron(I_N,A1)  zeros(15,10);
            zeros(10,20)  A_R    ];
A_R0_1_d_3 = [ zeros(5)  kron(-H,C*A1_d)  zeros(5,10);
             zeros(15,5)  kron(I_N,A1_d)  zeros(15,10);
             zeros(10,30)];

A_R0_2_3 = [    I_N  kron(-H,C*A2)  zeros(5)  kron(M,I_m);
            zeros(15,5)  kron(I_N,A2)  zeros(15,10);
            zeros(10,20)  A_R    ];
A_R0_2_d_3 = [ zeros(5)  kron(-H,C*A2_d)  zeros(5,10);
             zeros(15,5)  kron(I_N,A2_d)  zeros(15,10);
             zeros(10,30)];

B_R0_3 = [    kron(-H,C*B);
            kron(I_N,B);
            zeros(10,5) ];
G_hat_3 = eye(30) - B_R0*inv(B_R0'*B_R0)*B_R0';

F_3 = [ kron(-H,C);
      eye(15);
      zeros(10,15)];
D_3 = [ eye(5)  zeros(5,25) ];


Y = zeros(15,1);
  
X= [ kron(-H,C)*Y;
     Y;
     zeros(10,1) ]; % [e x1 x2 x3 r r1 d d1]

%%  R(k)
for k=1:1:500
    if k<25
        R(:,k) =zeros(5,1);
    elseif k>=25 & k<=50
        R(:,k) = ( (k-25)/10 )*100*ones(5,1);
    else
        R(:,k) = 2.5*100*ones(5,1);
    end
%       if k<10
%           R(:,k) =zeros(5,1);
%       elseif k>=10 & k<50
%           R(:,k) = 1.5*100*ones(5,1);
%       elseif k>=50 & k<100
%           R(:,k) = 3*100*ones(5,1);
%       elseif k>=100 & k<150
%           R(:,k) = 2*100*ones(5,1);
%       else
%           R(:,k) = 1*100*ones(5,1);
%       end
end

%% 滑模面、控制律、输出
for k=1:1:201
    time(k)=(k-1)/20;
%%
      %预见长度(1,1)
      Y1(:,k)=[Y(1,k) Y(4,k) Y(7,k) Y(10,k) Y(13,k)];
      Y2(:,k)=[Y(2,k) Y(5,k) Y(8,k) Y(11,k) Y(14,k)];
      Y3(:,k)=[Y(3,k) Y(6,k) Y(9,k) Y(12,k) Y(15,k)];
      Tr1(:,k)=kron(I_N,C)*Y(:,k);
      
      if k>1
          % 误差 e
          x11(:,k)= -kron(H,I_m) * (kron(I_N,C)*Y(:,k) - R(:,k));
          % Δx 
          x21(:,k)=Y1(:,k)-Y1(:,k-1);
          x31(:,k)=Y2(:,k)-Y2(:,k-1);
          x41(:,k)=Y3(:,k)-Y3(:,k-1);
      else
          x11(:,k)= -kron(H,I_m) * (kron(I_N,C)*Y(:,k) - R(:,k));
          
          x21(:,k)=Y1(:,k);
          x31(:,k)=Y2(:,k);
          x41(:,k)=Y3(:,k);
      end
      
      % ΔR(k)
      if k==1
          x51(:,k)=R(:,k);
          x61(:,k)=R(:,k+1)-R(:,k);
      else
          x51(:,k)=R(:,k)-R(:,k-1);
          x61(:,k)=R(:,k+1)-R(:,k);
      end
      
      h1(:,k) =  ( 1-1/(2+cos(-0.05*(k-0.5*pi) ) )  ) * ( 1-1/(2+cos(-0.05*(k+0.5*pi) ) )  );
      % h1(:,k) =  ( 1-1/(1+exp(-3*(k-0.5*pi) ) )  ) * ( 1-1/(1+exp(-3*(k+0.5*pi) ) )  );
      h2(:,k) = 1-h1(:,k);
      
      if k>1
         
          S3(:,k) = B_R0_3'*[x11(:,k);x21(:,k);x31(:,k);x41(:,k);x51(:,k);x61(:,k)] - B_R0_3'* ...
                  (   h1(:,k-1)*h1(:,k-1)*( A_R0_1_3 + B_R0_3*K1_30 )*[x11(:,k-1);x21(:,k-1);x31(:,k-1);x41(:,k-1);x51(:,k-1);x61(:,k-1)] + ...
                      h1(:,k-1)*h2(:,k-1)*( A_R0_1_3 + B_R0_3*K2_30 )*[x11(:,k-1);x21(:,k-1);x31(:,k-1);x41(:,k-1);x51(:,k-1);x61(:,k-1)] + ...
                      h2(:,k-1)*h1(:,k-1)*( A_R0_2_3 + B_R0_3*K1_30 )*[x11(:,k-1);x21(:,k-1);x31(:,k-1);x41(:,k-1);x51(:,k-1);x61(:,k-1)] + ...
                      h2(:,k-1)*h2(:,k-1)*( A_R0_2_3 + B_R0_3*K2_30 )*[x11(:,k-1);x21(:,k-1);x31(:,k-1);x41(:,k-1);x51(:,k-1);x61(:,k-1)]...
                  );
      else
          S3(:,k) = B_R0_3'*[x11(:,k);x21(:,k);x31(:,k);x41(:,k);x51(:,k);x61(:,k)];
      end
      
      e1=0;
      e2=0;
      
      % Δu(k) 的线性项
      for j=1:1:k
          e1=e1+x11(:,j);
      end

      % Δu(k) 的非线性项
      for j=1:1:k
          for jj=1:1:5
               sat(jj,j)=sign(S3(jj,j));
         end
          %W(:,j) = kron(ones(5,1),(  [ exp(-5*j)*cos(j) ;0]  )   );
         
          if j>1
             if j>4
                W(:,j) = ( h1(:,j)-h1(:,j-1)+h2(:,j)-h2(:,j-1) ) * (  kron(I_N,A1)*[Y1(:,j-1);Y2(:,j-1);Y3(:,j-1)] + kron(I_N,A1_d)*[Y1(:,j-3-1);Y2(:,j-3-1);Y3(:,j-3-1)] ) + ...
                          1*[ 0;0; -0.01*cos(Y(3,j))+0.04*Y(3,j);  0;0; -0.01*cos(Y(6,j))+0.04*Y(6,j);  0;0; -0.01*cos(Y(9,j))+0.04*Y(9,j); 0;0; -0.01*cos(Y(12,j))+0.04*Y(12,j); 0;0; -0.01*cos(Y(15,j))+0.04*Y(15,j) ]; 
                
                %e2=e2 + inv(B_R0_3'*B_R0_3)* (  (0.54-1)*S3(:,j) + 0.5*sat + norm(inv(B_R0_3'*B_R0_3)*B_R0_3'*F_3) * norm( W(:,j)) ) +  0.01*norm( [x21(:,j) zeros(5,1) zeros(5,1) ] );
                
                gbgf=inv(B_R0_3'*B_R0_3)*B_R0_3'*F_3;
                e2=e2 + inv(B_R0_3'*B_R0_3)* (  (0.54-1)*S3(:,j) + 0.5*sat(:,j) + ...
                   [ norm(gbgf(:,1:5)) ,norm(gbgf(:,6:10)) ,norm(gbgf(:,11:15)) ]* [ norm( W(1:5,j)); norm( W(5:10,j)); norm( W(11:15,j)) ] )...
                   +  0.01*norm( [x21(:,j) zeros(5,1) zeros(5,1) ] ) ;
             else
                 W(:,j) = ( h1(:,j)-h1(:,j-1)+h2(:,j)-h2(:,j-1) ) * (  kron(I_N,A1)*[Y1(:,j-1);Y2(:,j-1);Y3(:,j-1)] ) + ...
                          1*[ 0;0; -0.01*cos(Y(3,j))+0.04*Y(3,j);  0;0; -0.01*cos(Y(6,j))+0.04*Y(6,j);  0;0; -0.01*cos(Y(9,j))+0.04*Y(9,j); 0;0; -0.01*cos(Y(12,j))+0.04*Y(12,j); 0;0; -0.01*cos(Y(15,j))+0.04*Y(15,j) ] ;
                
                %e2=e2 + inv(B_R0_3'*B_R0_3)* (  (0.54-1)*S3(:,j) + 0.5*sat + norm(inv(B_R0_3'*B_R0_3)*B_R0_3'*F_3) * norm( W(:,j)) ) +  0.01*norm( [x21(:,j) zeros(5,1) zeros(5,1) ] );
                gbgf=inv(B_R0_3'*B_R0_3)*B_R0_3'*F_3;
                e2=e2 + inv(B_R0_3'*B_R0_3)* (  (0.54-1)*S3(:,j) + 0.5*sat(:,j) + ...
                   [ norm(gbgf(:,1:5)) ,norm(gbgf(:,6:10)) ,norm(gbgf(:,11:15)) ]* [ norm( W(1:5,j)); norm( W(5:10,j)); norm( W(11:15,j)) ] )...
                   +  0.01*norm( [x21(:,j) zeros(5,1) zeros(5,1) ] ) ;
             end
             
          else
               W(:,j) = 1*[ 0;0; -0.01*cos(Y(3,j))+0.04*Y(3,j);  0;0; -0.01*cos(Y(6,j))+0.04*Y(6,j);  0;0; -0.01*cos(Y(9,j))+0.04*Y(9,j); 0;0; -0.01*cos(Y(12,j))+0.04*Y(12,j); 0;0; -0.01*cos(Y(15,j))+0.04*Y(15,j) ];
               
              %e2=e2 + inv(B_R0_3'*B_R0_3)* (  (0.54-1)*S3(:,j) + 0.5*sat + norm(inv(B_R0_3'*B_R0_3)*B_R0_3'*F_3) * norm( W(:,j)) ) + 0.01*norm([x21(:,j) zeros(5,1) zeros(5,1) ]);
                gbgf=inv(B_R0_3'*B_R0_3)*B_R0_3'*F_3;
                e2=e2 + inv(B_R0_3'*B_R0_3)* (  (0.54-1)*S3(:,j) + 0.5*sat(:,j) + ...
                   [ norm(gbgf(:,1:5)) ,norm(gbgf(:,6:10)) ,norm(gbgf(:,11:15)) ]* [ norm( W(1:5,j)); norm( W(5:10,j)); norm( W(11:15,j)) ] )...
                   +  0.01*norm( [x21(:,j) zeros(5,1) zeros(5,1) ] ) ;
          end
      end
      
      if k>3
         U3(:,k)=( h1(:,k)*K1_30+h2(:,k)*K2_30 ) * [e1;Y1(:,k);Y2(:,k);Y3(:,k);R(:,k);R(:,k+1)] - ...
                 ( h1(:,k)*inv(B_R0_3'*B_R0_3)*B_R0_3'*A_R0_1_d +  h2(:,k)*inv(B_R0_3'*B_R0_3)*B_R0_3'*A_R0_2_d ) *...
                 [ e1;Y1(:,k-3);Y2(:,k-3);Y3(:,k-3);R(:,k-3);R(:,k+1-3) ] -e2 ;
             
         Y(:,k+1) =  h1(:,k) * (  kron(I_N,A1)*Y(:,k) + kron(I_N,A1_d)*Y(:,k-3) + kron(I_N,B)*( U3(:,k)+0.01*[sin(Y(1,k));sin(Y(4,k)); sin(Y(7,k)); sin(Y(10,k)); sin(Y(13,k)) ] ) ...
                      + 1*[ 0;0; -0.01*cos(Y(3,k))+0.04*Y(3,k);  0;0; -0.01*cos(Y(6,k))+0.04*Y(6,k);  0;0; -0.01*cos(Y(9,k))+0.04*Y(9,k); 0;0; -0.01*cos(Y(12,k))+0.04*Y(12,k); 0;0; -0.01*cos(Y(15,k))+0.04*Y(15,k) ]   ) +...
                      h2(:,k) * (  kron(I_N,A2)*Y(:,k) + kron(I_N,A2_d)*Y(:,k-3) + kron(I_N,B)*( U3(:,k)+0.01*[sin(Y(1,k)); sin(Y(4,k)); sin(Y(7,k)); sin(Y(10,k)); sin(Y(13,k)) ] )...
                      + 1*[ 0;0; -0.01*cos(Y(3,k))+0.04*Y(3,k);  0;0; -0.01*cos(Y(6,k))+0.04*Y(6,k);  0;0; -0.01*cos(Y(9,k))+0.04*Y(9,k); 0;0; -0.01*cos(Y(12,k))+0.04*Y(12,k); 0;0; -0.01*cos(Y(15,k))+0.04*Y(15,k) ] ) ;
      else
          U3(:,k)=( h1(:,k)*K1_30+h2(:,k)*K2_30 ) * [e1;Y1(:,k);Y2(:,k);Y3(:,k);R(:,k);R(:,k+1)] - e2 ;
          
          Y(:,k+1) =  h1(:,k) * (  kron(I_N,A1)*Y(:,k) + kron(I_N,B)*( U3(:,k)+0.01*[sin(Y(1,k)); sin(Y(4,k)); sin(Y(7,k)); sin(Y(10,k)); sin(Y(13,k)) ] )...
                      + 1*[ 0;0; -0.01*cos(Y(3,k))+0.04*Y(3,k);  0;0; -0.01*cos(Y(6,k))+0.04*Y(6,k);  0;0; -0.01*cos(Y(9,k))+0.04*Y(9,k); 0;0; -0.01*cos(Y(12,k))+0.04*Y(12,k); 0;0; -0.01*cos(Y(15,k))+0.04*Y(15,k) ] ) + ...
                      h2(:,k) * (  kron(I_N,A2)*Y(:,k) + kron(I_N,B)*( U3(:,k)+0.01*[sin(Y(1,k)); sin(Y(4,k)); sin(Y(7,k)); sin(Y(10,k)); sin(Y(13,k)) ] )...
                      + 1*[ 0;0; -0.01*cos(Y(3,k))+0.04*Y(3,k);  0;0; -0.01*cos(Y(6,k))+0.04*Y(6,k);  0;0; -0.01*cos(Y(9,k))+0.04*Y(9,k); 0;0; -0.01*cos(Y(12,k))+0.04*Y(12,k); 0;0; -0.01*cos(Y(15,k))+0.04*Y(15,k) ] ) ;
      end
     
end

%% R1(k)
for k=1:1:201
    if k<25
       R1(:,k) =zeros(5,1);
    elseif k>=25 & k<=50
        R1(:,k) = ( (k-25)/10 )*100*ones(5,1);
    else
       R1(:,k) = 2.5*100*ones(5,1);
    end
%       if k<10
%           R1(:,k) =zeros(5,1);
%       elseif k>=10 & k<50
%           R1(:,k) = 1.5*100*ones(5,1);
%       elseif k>=50 & k<100
%           R1(:,k) = 3*100*ones(5,1);
%       elseif k>=100 & k<150
%           R1(:,k) = 2*100*ones(5,1);
%       else
%           R1(:,k) = 1*100*ones(5,1);
%       end
end

%% 
figure(1);
plot(time,R1(1,:)/100,'k-',time,Tr1(1,:)/100,time,Tr1(2,:)/100,time,Tr1(3,:)/100,time,Tr1(4,:)/100,time,Tr1(5,:)/100,'LineWidth',1);
xlabel('time(s)','FontName','Times New Roman','FontSize',12);
ylabel('output response','FontName','Times New Roman','FontSize',12);
f1=legend('$r_{k}$','agent1','agent2','agent3','agent4','agent5','Location','NorthWest','FontName','Times New Roman');
set(f1,'Interpreter','latex','fontsize',10);

axes('Position',[0.4,0.5,0.5,0.2]); % 生成子图   
plot(time,R1(1,:)/100,'k-',time,Tr1(1,:)/100,time,Tr1(2,:)/100,time,Tr1(3,:)/100,time,Tr1(4,:)/100,time,Tr1(5,:)/100,'LineWidth',1);
ylim([1.7411,1.7412]); % 放大的横坐标
xlim([2.06,2.255]); % 放大的横坐标

figure(2);
plot(time,S3(1,:)/100,time,S3(2,:)/100,time,S3(3,:)/100,time,S3(4,:)/100,time,S3(5,:)/100,'LineWidth',1);
xlabel('time(s)','FontName','Times New Roman','FontSize',12);
ylabel('sliding mode surface ','FontName','Times New Roman','FontSize',12);
legend('agent1','agent2','agent3','agent4','agent5','FontName','Times New Roman','FontSize',10);

figure(3);
plot(time,U3(1,:)/100,time,U3(2,:)/100,time,U3(3,:)/100,time,U3(4,:)/100,time,U3(5,:)/100,'LineWidth',1);
xlabel('time(s)','FontName','Times New Roman','FontSize',12);
ylabel('control input','FontName','Times New Roman','FontSize',12);
legend('agent1','agent2','agent3','agent4','agent5','FontName','Times New Roman','FontSize',10);

axes('Position',[0.4,0.4,0.5,0.2]); % 生成子图   
plot(time,U3(1,:)/100,time,U3(2,:)/100,time,U3(3,:)/100,time,U3(4,:)/100,time,U3(5,:)/100,'LineWidth',1);
ylim([-33.8516,-33.851]); % 放大的横坐标
xlim([1.955,2.025]); % 放大的横坐标

figure(4);
plot(time,x11(1,:)/100,time,x11(2,:)/100,time,x11(3,:)/100,time,x11(4,:)/100,time,x11(5,:)/100,'LineWidth',1);
xlabel('time(s)','FontName','Times New Roman','FontSize',12);
ylabel('tracking error','FontName','Times New Roman','FontSize',12);
legend('agent1','agent2','agent3','agent4','agent5','FontName','Times New Roman','FontSize',10);

% figure(5);
% plot(time,h1,time,h2,'LineWidth',1);
% xlabel('time(s)','FontName','Times New Roman','FontSize',12);
% ylabel('h','FontName','Times New Roman','FontSize',12);
% legend('h1','h2','FontName','Times New Roman','FontSize',10);